// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
}

// --- ENUMS (TYPE SAFETY) ---
enum TripStatus {
  DRAFT      
  CONFIRMED  
  COMPLETED 
  CANCELLED 
}

enum BookingStatus {
  DRAFT
  PENDING_APPROVAL 
  CONFIRMED        
  REJECTED         
  CANCELLED
  FAILED
}

enum BookingType {
  FLIGHT
  HOTEL
  ACTIVITY
}

enum AuditSeverity {
  INFO
  WARNING
  CRITICAL
}

// --- MODEL DATABASE: USER & CONTEXT ---

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  
  // JSON: {"seat": "window", "food": "halal", "maxBudgetPerTrip": 5000000}
  preferences   String?   
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  paymentMethods PaymentMethod[]
  trips          Trip[]
  calendar       CalendarEvent[]
  auditLogs      AuditLog[]
  searchPreference SearchPreference?
}

model PaymentMethod {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  last4Digits   String   
  token         String   
  brand         String   
  isDefault     Boolean  @default(false)
  trips         Trip[]   
}

model CalendarEvent {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  title       String
  start       DateTime
  end         DateTime
  description String?
  isAllDay    Boolean  @default(false)
}

model Trip {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  name            String   
  description     String?
  status          TripStatus @default(DRAFT) 
  startDate       DateTime? 
  endDate         DateTime?
  paymentMethodId String?
  paymentMethod   PaymentMethod? @relation(fields: [paymentMethodId], references: [id])
  
  bookings        Booking[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// --- MASTER DATA: LOCATION ---

model Location {
  id          String   @id @default(cuid())
  name        String   // e.g. "Bali", "Jakarta", "Singapore"
  code        String   @unique // IATA Code (e.g. "DPS", "JKT", "SIN")
  country     String   // e.g. "Indonesia"
  image       String?  // URL Image
  description String?  
  
  airports    Flight[] @relation("Origin")
  arrivals    Flight[] @relation("Destination")
  hotels      Hotel[]
  activities  Activity[]
}

// --- INVENTORY MOCK (LINKED TO LOCATION) ---

model Flight {
  id          String   @id @default(cuid())
  airline     String
  flightCode  String   
  
  // [UPDATED] Relasi ke Location (Origin)
  originCode  String
  origin      Location @relation("Origin", fields: [originCode], references: [code])
  
  // [UPDATED] Relasi ke Location (Destination)
  destCode    String
  destination Location @relation("Destination", fields: [destCode], references: [code])
  
  departure   DateTime
  arrival     DateTime
  price       Int
  
  availableSeats Int   @default(60) 
  
  bookings    Booking[]
}

model Hotel {
  id            String   @id @default(cuid())
  name          String
  
  // [UPDATED] Relasi ke Location (Pengganti kolom 'city' string)
  locationId    String
  location      Location @relation(fields: [locationId], references: [id])
  
  address       String? 
  rating        Float
  pricePerNight Int
  amenities     String? // JSON String
  
  bookings      Booking[]
}

model Activity {
  id          String   @id @default(cuid())
  name        String
  
  // [UPDATED] Relasi ke Location
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])
  
  durationMin Int
  price       Int
  
  bookings    Booking[]
}

// --- TRANSACTION & LOGS ---

model Booking {
  id            String   @id @default(cuid())
  tripId        String
  trip          Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)

  // [UPDATED] Pakai Enum
  type          BookingType   
  
  flightId      String?
  flight        Flight?  @relation(fields: [flightId], references: [id])
  hotelId       String?
  hotel         Hotel?   @relation(fields: [hotelId], references: [id])
  activityId    String?
  activity      Activity? @relation(fields: [activityId], references: [id])
  
  totalAmount   Int
  bookingDetails String? // JSON Detail
  
  // [UPDATED] Kolom Wajib untuk Cek Bentrok Jadwal
  startDate     DateTime 
  endDate       DateTime 

  // [UPDATED] Pakai Enum (Risk Mitigation)
  status        BookingStatus @default(PENDING_APPROVAL) 
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model AuditLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  action      String   
  metadata    String?  
  
  severity    AuditSeverity @default(INFO)
  
  timestamp   DateTime @default(now())
}

// --- USER SEARCH PREFERENCES (Persisted per-user, used to store parsed search params)
model SearchPreference {
  id         String   @id @default(cuid())
  userId     String   @unique
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  parameters Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// Idempotency store for agent/tool calls to prevent duplicate external provider actions
model IdempotencyKey {
  id         String   @id @default(cuid())
  key        String   @unique
  toolCallId  String?
  metadata   String?  // optional JSON
  used       Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}